{% extends 'base.html' %}
{% block title %}Пациент · Healthcare CRM{% endblock %}
{% block breadcrumb %}Модули / <a class="text-blue-600 hover:underline" href="{% url 'patient_list' %}">Пациенты</a> / Карточка{% endblock %}
{% block header %}Карточка пациента{% endblock %}

{% block content %}
<div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
  <section class="card p-5 lg:col-span-2">
    <div class="flex items-start justify-between gap-4">
      <div>
        <h2 class="text-lg font-semibold">{{ patient.ism }}</h2>
        <p class="text-sm text-slate-600 mt-1">ID: {{ patient.id }} · {{ patient.yosh }} yosh</p>
      </div>
      <div class="flex gap-2">
        <a class="btn" href="{% url 'patient_edit' patient.id %}"><i class="fa-regular fa-pen-to-square"></i> Редактировать</a>
        <a class="btn btn-primary" href="{% url 'health_screening_create' patient.id %}">
          <i class="fa-solid fa-stethoscope"></i> Скрининг
        </a>
      </div>
    </div>

    <div class="mt-6 grid grid-cols-1 sm:grid-cols-2 gap-4">
      <div class="rounded-2xl border border-slate-200 bg-slate-50 p-4">
        <div class="text-xs text-slate-500">Телефон</div>
        <div class="font-semibold mt-1">{{ patient.telefon|default:"—" }}</div>
      </div>
      <div class="rounded-2xl border border-slate-200 bg-slate-50 p-4">
        <div class="text-xs text-slate-500">Пол</div>
        <div class="font-semibold mt-1">{{ patient.get_jins_display }}</div>
      </div>
      <div class="rounded-2xl border border-slate-200 bg-slate-50 p-4">
        <div class="text-xs text-slate-500">Адрес</div>
        <div class="font-semibold mt-1">{{ patient.manzil|default:"—" }}</div>
      </div>
      <div class="rounded-2xl border border-slate-200 bg-slate-50 p-4">
        <div class="text-xs text-slate-500">Группа крови</div>
        <div class="font-semibold mt-1">{{ patient.qon_guruhi|default:"—" }}</div>
      </div>
    </div>

    <div class="mt-6">
      <h3 class="font-semibold">Последние встречи</h3>
      <div class="mt-3 overflow-hidden rounded-2xl border border-slate-200">
        <table class="table">
          <thead>
            <tr>
              <th>Дата</th>
              <th>Отдел</th>
              <th>Статус</th>
              <th>Риск</th>
            </tr>
          </thead>
          <tbody>
            {% for a in appointments %}
              <tr>
                <td class="text-slate-700">{{ a.uchrashuv_sanasi|date:"d.m.Y H:i" }}</td>
                <td class="text-slate-700">{{ a.get_bolim_display }}</td>
                <td class="text-slate-700">{{ a.get_holat_display }}</td>
                <td class="text-slate-700">{{ a.kelmay_qolish_riski|floatformat:2 }}</td>
              </tr>
            {% empty %}
              <tr><td colspan="4" class="text-slate-600">Нет встреч.</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

    <div class="mt-6">
      <h3 class="font-semibold">Скрининги</h3>
      <div class="mt-3 space-y-2">
        {% for s in screenings %}
          <div class="rounded-2xl border border-slate-200 bg-slate-50 p-4">
            <div class="flex items-center justify-between">
              <div class="text-sm text-slate-700">#{{ s.id }} · {{ s.tekshiruv_sanasi|date:"d.m.Y H:i" }}</div>
              <div class="text-xs text-slate-500">{{ s.bolim|default:"" }}</div>
            </div>
          </div>
        {% empty %}
          <div class="text-sm text-slate-600">Скринингов нет.</div>
        {% endfor %}
      </div>
    </div>
  </section>

  <aside class="card p-5">
    <h2 class="text-lg font-semibold">AI Риски</h2>
    <p class="text-sm text-slate-600 mt-1">То, что уже вычисляет ваш backend.</p>

    <div class="mt-4 space-y-3">
      <div class="rounded-2xl border border-slate-200 bg-slate-50 p-4">
        <div class="text-xs text-slate-500">Diabetes</div>
        <div class="text-xl font-bold mt-1">{{ diabetes_risk|floatformat:2 }}</div>
        <div class="mt-2"><span class="badge badge-warn">{{ diabetes_risk_level }}</span></div>
      </div>

      <div class="rounded-2xl border border-slate-200 bg-slate-50 p-4">
        <div class="text-xs text-slate-500">Heart</div>
        <div class="text-xl font-bold mt-1">{{ heart_risk|floatformat:2 }}</div>
        <div class="mt-2"><span class="badge badge-warn">{{ heart_risk_level }}</span></div>
      </div>

      <form method="post" action="{% url 'patient_delete' patient.id %}" onsubmit="return confirm('Удалить пациента?');">
        {% csrf_token %}
        <button class="btn w-full justify-center border-rose-200 bg-rose-50 text-rose-700 hover:bg-rose-100" type="submit">
          <i class="fa-regular fa-trash-can"></i> Удалить пациента
        </button>
      </form>
    </div>
  </aside>
</div>
{% endblock %}
